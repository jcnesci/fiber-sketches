<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">

<link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,400,700,300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" type="text/css" href="sketches.css">
</head>
<body>
<script src="jquery-1.10.2.js"></script>
<script src="jquery-svg/jquery.svg.js"></script>
<script type="text/javascript" src="jquery-svg/jquery.svgdom.js"></script>

<script src="device.js"></script>
<script src="connection.js"></script>
<script src="layout.js"></script>
<script src="common.js"></script>

<script>
var devices = [];			// All devices
var personal_devices = [];	// Computers/laptops and mobile devices
var routing_devices = []; 	// Network boxes, tv boxes, or other routers/switches
var connections = [];

// Drag-and-drop specific stuff
var dragging = null; // item that is being dragged
var hovering = null; // item currently hovering over


$(document).ready(function() {
	$("#svg_container").svg();	// Initialize the SVG canvas

	populateDevices();
	layoutDevices("tree");

});

function populateDevices() {
	// Clear out old lists. TODO: Make sure circular references are broken, too
	$.each(devices, function(index, device) {
		device.die();
	});

	$.each(connections, function(index, connection) {
			connection.die();
	});

	devices.length = 0;
	personal_devices.length = 0;
	routing_devices.length = 0;
	connections.length = 0;

	devices.push(new Device("Network Box", "networkbox"));	// devices[0] is always the network box
	routing_devices.push(devices[0]);
	devices[0].mass = 100;

	var random_names = ["Ralph", "Elena", "Rex", "Mordecai", "Betty White", "Nancy", "Jamilah"];
	var random_rooms = ["Office", "Poolside", "Living Room", "Bedroom", "Upstairs", "Downstairs"]
	var n_personal_devices = Math.round(Math.random() * 8 + 2);
	var n_tv_devices = Math.round(Math.random() * 3);

	// Create personal devices (phones, laptops, etc)
	for(var i=0; i<n_personal_devices; i++) {
		var type = Math.random() < 0.5 ? "phone" : "laptop";
		var propertype = type.charAt(0).toUpperCase() + type.slice(1);

		var unique_name = false;
		var name = ""; 
		while(!unique_name) {
			name = random_names[Math.round(Math.random() * (random_names.length-1))] + "'s " + propertype;
			// Check all devices to see if this name is taken
			var taken = false;
			for(var j=0; j<devices.length; j++) {
				if(devices[j].name == name) taken = true;
			}
			if(!taken) unique_name = true;
		}
		
		var dev = new Device(name, type);
		devices.push(dev);
		personal_devices.push(dev);
	}

	// Create TV devices which always come in a pairs with a TV box
	for(var i=0; i<n_tv_devices; i++) {
		var room = random_rooms[Math.round(Math.random() * (random_rooms.length-1))];
		var box_device = new Device(room + " TV Box", "tvbox");
		var tv_device = new Device(room + " TV", "tv");
		devices.push(box_device);
		routing_devices.push(box_device);
		devices.push(tv_device);

		// Connect TVs to TV Box
		connections.push(new Connection(box_device, tv_device, "wired", 1));

		// Connect TV Box to Network Box
		connections.push(new Connection(devices[0], box_device, "wired", 1));
	}


	// Connect each device to a router
	$.each(personal_devices, function(index, device) {
		var router = Math.random() < 0.8 ? devices[0] : routing_devices[random(0, routing_devices.length)];	// Favor network box

		var type = Math.random() < 0.5 ? "wired" : "wireless";
		connections.push(new Connection(router, device, type, 1));	
	});

	// Assign drop event handler for each device
	$.each(devices, function(index, device) {
		device.el.mouseup((function(dev) { return function() {
			// DROPPED
			if(dragging != null) {
				if($(dragging).hasClass("device"))
					dev.changeType($(dragging).data("type"));	
				else if($(dragging).hasClass("ip")) {
					dev.ip = $(dragging).text();
					dev.static_ip = true;
					dev.toggleStatus();

					//$(dragging).appendTo(dev.el.find(".ip_slot"));
					$(dragging).remove();
				}
				dev.highlight(false);
			}
		} })(device));

		device.el.mouseenter((function(dev) { return function(ev) {
			if(dragging != null) {
				dev.highlight(true);	
			}
		} })(device));
		device.el.mouseleave((function(dev) { return function(ev) {
			if(dragging != null) {
				dev.highlight(false);	
			}
		} })(device));
		

		device.el.find(".icon").click((function(dev) { return function(ev) {
			dev.toggleStatus();
			return true;
		}})(device));
		
	});
	// Clear dragging when mouseup anywhere else
	$(document).mouseup(function() {
		$(dragging).removeAttr("style");
		$(dragging).removeClass("dragging");

		dragging = null;
		//return false;
	});

	// Assign drag handlers for icon palette items
	$.each($("#icon_palette > .device"), function(item, el) {
		$(el).mousedown(function() {
			dragging = this;
			return false;
		});		

	});

	// Assign drag handlers for static IP address items
	$.each($("#ip_palette > .ip"), function(item, el) {
		$(el).mousedown(function() {
			dragging = this;
			return false;
		});		

	});

	$(document).mousemove(function(ev) {
		if(!dragging) return true;
		else {
			var w = $(dragging).width();
			var h = $(dragging).height();
			$(dragging).offset({left: ev.pageX-w/2, top: ev.pageY-h/2});
			$(dragging).addClass("dragging");
		}
		return true;
	});

	setConnectorStyle("90s");
}


</script>
<div id="sketchList"></div>
<div id="controller">
	<h2>OPTIONS:</h2>
	<div class="button" onClick="populateDevices(); layoutDevices()">New Network</div>
	<div class="button" onClick="toggleConnectors(this)">Toggle connector style</div>
	<div id="icon_palette" class="palette">
		<h2>ICONS:</h2>
		<div class="device laptop" data-type="laptop"><div class="icon"></div></div>
		<div class="device router" data-type="router"><div class="icon"></div></div>
		<div class="device tv" data-type="tv"><div class="icon"></div></div>
		<div class="device phone" data-type="phone"><div class="icon"></div></div>
	</div>
	<div id="ip_palette" class="palette">
		<h2>STATIC IPs:</h2>
		<div class="ip">64.233.160.0</div>
		<div class="ip">64.233.160.1</div>
		<div class="ip">64.233.160.2</div>
		<div class="ip">64.233.160.3</div>
		<div class="ip">64.233.160.4</div>
	</div>	
</div>

<div id="container">

</div>
<div id="svg_container"></div>
<!--<svg id="svgelem" xmlns="http://www.w3.org/2000/svg">
    <line x1="0" y1="0" x2="200" y2="100"
          style="stroke:red;stroke-width:2px"></line>
</svg>-->
</body>
</html>